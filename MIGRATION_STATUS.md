# Migration Setup Status

## ‚úÖ Completed Steps

1. **Added EF Core Design Package**: The `Microsoft.EntityFrameworkCore.Design` package (v8.0.11) has been added to the FriendShare.Infrastructure project. This package is required for creating and managing migrations.

2. **Created Documentation**: Comprehensive migration documentation has been created in `MIGRATIONS.md` with all necessary commands and workflows.

3. **Created Helper Script**: A `migrations.sh` script has been created to simplify common migration operations.

4. **Updated README**: The main README.md now includes migration setup instructions.

5. **Configured Auto-Migration**: The API's `Program.cs` has been updated to automatically apply pending migrations on startup in Development mode.

## ‚ö†Ô∏è Next Steps Required

The actual migration files need to be generated by running the `dotnet ef` command. This requires:

1. **Install EF Core Tools** (if not already installed):
   ```bash
   dotnet tool install --global dotnet-ef
   ```

2. **Create Initial Migration**:
   ```bash
   cd /path/to/repository
   ./migrations.sh create InitialCreate
   ```
   
   Or manually:
   ```bash
   dotnet ef migrations add InitialCreate \
     --project src/FriendShare.Infrastructure \
     --startup-project src/FriendShare.Api
   ```

3. **Verify Migration Files**: After running the command, you should see new files created in:
   ```
   src/FriendShare.Infrastructure/Migrations/
   ‚îú‚îÄ‚îÄ <timestamp>_InitialCreate.cs
   ‚îú‚îÄ‚îÄ <timestamp>_InitialCreate.Designer.cs
   ‚îî‚îÄ‚îÄ ApplicationDbContextModelSnapshot.cs
   ```

4. **Apply Migration**: The migration will be automatically applied when the API starts in Development mode, or you can manually apply it:
   ```bash
   ./migrations.sh update
   ```

## üóÑÔ∏è Expected Database Schema

When the migration is created and applied, it will generate the following tables:

### Identity Tables
- **AspNetUsers** - User accounts
  - Standard fields: Id, UserName, Email, PasswordHash, SecurityStamp, etc.
  - Custom fields: FirstName, LastName, Bio, PhotoUrl, CreatedAt, UpdatedAt, IsActive, RefreshToken, RefreshTokenExpiryTime
- **AspNetRoles** - User roles
- **AspNetUserRoles** - User-Role relationships
- **AspNetUserClaims** - User claims
- **AspNetRoleClaims** - Role claims
- **AspNetUserLogins** - External login providers
- **AspNetUserTokens** - Authentication tokens

### Key Indexes
- IX_AspNetUsers_RefreshToken
- EmailIndex (on NormalizedEmail)
- UserNameIndex (unique, on NormalizedUserName)
- RoleNameIndex (unique, on NormalizedName)

## üîß Troubleshooting

If you encounter issues when creating migrations:

1. **Ensure all projects build successfully**:
   ```bash
   dotnet build
   ```

2. **Verify connection string** in `src/FriendShare.Api/appsettings.Development.json`:
   ```json
   {
     "ConnectionStrings": {
       "DefaultConnection": "Host=localhost;Port=5432;Database=friendshare;Username=your_user;Password=your_password"
     }
   }
   ```

3. **Check EF Core tools are installed**:
   ```bash
   dotnet ef --version
   ```

## üìù Why Migrations Weren't Generated Automatically

EF Core migrations are code-generated files that are created by the `dotnet ef migrations add` command. This command:
1. Analyzes the current DbContext and entity configurations
2. Compares with existing migrations (or starts from scratch)
3. Generates C# code that represents the schema changes
4. Creates Designer and Snapshot files for tracking

These files cannot be manually created without the tool because they include:
- Auto-generated timestamps
- Model snapshots with metadata
- Compiled model references
- Version-specific EF Core annotations

The files must be generated by the EF Core tooling to ensure compatibility and correctness.

## ‚ú® What's Already Set Up

- ‚úÖ ApplicationDbContext configured with Identity
- ‚úÖ ApplicationUser entity with custom properties
- ‚úÖ Entity configurations with constraints and indexes
- ‚úÖ PostgreSQL provider configured
- ‚úÖ Design-time package installed
- ‚úÖ Auto-migration on startup (Development mode)
- ‚úÖ Documentation and helper scripts ready

All prerequisites are in place. Simply run `./migrations.sh create InitialCreate` to generate the migration files.
